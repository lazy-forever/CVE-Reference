# CVE-2024-43033

## Vulnerability Reproduction

Similar to the [jpress前台存在任意文件上传漏洞 · Issue #173 · JPressProjects/jpress (github.com)](https://github.com/JPressProjects/jpress/issues/173)

Deploy JPress on Windows

After installing the JPress framework, register a user.

http://localhost/user/register

<img width="692" alt="1" src="./assets/1.png">

After registration, go to the avatar settings (`http://localhost/ucenter/avatar`), select an image, and capture the packet to submit.

<img width="730" alt="2" src="./assets/2.png">

If you upload an HTML file normally, it shows that uploading is not supported.

<img width="842" alt="3" src="./assets/3.png">

Uploading a JSP file will have its suffix changed.

<img width="948" alt="4" src="./assets/4.png">

When we add `::$DATA` to the end of the file name and send the packet.

<img width="931" alt="5" src="./assets/5.png">

The normal file should be saved at `/attachment/20240803/b91be30530c843f8aed2c08bb2222ddc.jsp::$DATA`, but the final file is saved at `/attachment/1.jsp`.

<img width="708" alt="6" src="./assets/6.png">

The same applies to HTML files, so it is not elaborated.

## Vulnerability Analysis

Located in the `io.jpress.web.commons.controller.AttachmentController#upload` method, line 55 calls the `ControllerBase#getFile` method.

<img width="803" alt="7" src="./assets/7.png">

Then `getFile` calls the `getFirstFileOnly` method.

<img width="760" alt="8" src="./assets/8.png">

The `getFirstFileOnly` method calls `this.getFiles()` to save the file at `/attachment/1.jsp::$DATA`, but due to the characteristics of Windows, the `::\$DATA` suffix is ignored, causing the file to be saved at `/attachment/1.jsp`.

<img width="698" alt="9" src="./assets/9.png">

Finally, at line 90 of the `io.jpress.web.commons.controller.AttachmentController#upload` method, an error is triggered, preventing the file from being moved further, so the file is saved at `/attachment/1.jsp`.

<img width="1210" alt="10" src="./assets/10.png">
